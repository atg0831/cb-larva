<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cloud-Barista Network</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"
            type="text/javascript"></script>

    <script src="/js/code/highcharts.js"></script>
    <script src="/js/code/highcharts-more.js"></script>
    <script src="/js/code/modules/exporting.js"></script>
    <script src="/js/code/modules/accessibility.js"></script>

    <link rel="stylesheet" href="/introspect/assets/css/main.css"/>

    <style type="text/css">
        .highcharts-figure, .highcharts-data-table table {
            min-width: 320px;
            max-width: 800px;
            margin: 1em auto;
        }

        .highcharts-data-table table {
            font-family: Verdana, sans-serif;
            border-collapse: collapse;
            border: 1px solid #EBEBEB;
            margin: 10px auto;
            text-align: center;
            width: 100%;
            max-width: 500px;
        }

        .highcharts-data-table caption {
            padding: 1em 0;
            font-size: 1.2em;
            color: #555;
        }

        .highcharts-data-table th {
            font-weight: 600;
            padding: 0.5em;
        }

        .highcharts-data-table td, .highcharts-data-table th, .highcharts-data-table caption {
            padding: 0.5em;
        }

        .highcharts-data-table thead tr, .highcharts-data-table tr:nth-child(even) {
            background: #f8f8f8;
        }

        .highcharts-data-table tr:hover {
            background: #f1f7ff;
        }

    </style>
</head>
<body>

<!-- Header -->
<header id="header">
    <div class="inner">
        <a href="index.html" class="logo">Cloud-Barista</a>
        <nav id="nav">
            <a href="/">Home</a>
            <a href="#cb-net-conf">cb-network</a>
            <a href="#cladnet-list">CLADNet</a>
        </nav>
    </div>
</header>
<a href="#menu" class="navPanelToggle"><span class="fa fa-bars"></span></a>

<!-- Banner -->
<section id="banner">
    <div class="inner">
        <h1>The AdminWeb of Cloud-Barista Network</h1>
        <ul class="actions">
            <li><a href="#cb-net-conf" class="button alt">See AdminWeb</a></li>
        </ul>
    </div>
</section>

<!-- The configuration of cb-network -->
<section id="cb-net-conf" class="one">
    <div class="inner">
        <header>
            <h2 class="align-center">The configuration of cb-network </h2>
        </header>
        <div class="row">
            <div class="6u 12u$(xsmall)">
                <h4 class="align-center">Networking Rule Table</h4>
                <div class="table-wrapper">
                    <table>
                        <thead>
                        <tr>
                            <th class="align-center">Host ID</th>
                            <th class="align-center">Host IP CIDR Block</th>
                            <th class="align-center">Host IP Address</th>
                            <th class="align-center">Public IP</th>
                        </tr>
                        </thead>
                        <tbody id="net-rule-data">
                        <tr>
                            <td class="align-center">To</td>
                            <td class="align-center">be</td>
                            <td class="align-center">updated</td>
                            <td class="align-center">:)</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="6u$ 12u$(xsmall)">
                <figure class="highcharts-figure">
                    <div id="container"></div>
                    <!--<p class="highcharts-description">
                        This chart shows the Cloud-Barista Network configuration by the packed bubble charts provided from
                        Highcharts.
                    </p>-->
                </figure>
            </div>
        </div>

    </div>
</section>

<!-- The list of cloud adaptive network (CLADNet)-->
<section id="cladnet-list" class="one">
    <div class="inner">
        <!--        <header> -->
        <!--            <h2 class="align-center">AdminWeb: cb-network creation</h2> -->
        <!--        </header> -->
        <div>
            <div>
                <h4 class="align-center">A list of Cloud Adaptive Network</h4>
                <div class="table-wrapper">
                    <table>
                        <thead>
                        <tr>
                            <th class="align-center">ID</th>
                            <th class="align-center">IPv4 CIDR block</th>
                            <th class="align-center">Description</th>
                        </tr>
                        </thead>
                        <tbody id="cladnet-data">
                        <tr>
                            <td class="align-center">To</td>
                            <td class="align-center">be</td>
                            <td class="align-center">updated :)</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- The creation interface of cloud adaptive network -->
<section id="cladnet-creation" class="one">
    <div class="inner">
        <div>
            <div>
                <h4 class="align-center">Create your CLADNet: Cloud Adoptive Network</h4>
                <div class="table-wrapper">
                    <table>
                        <tbody>
                        <tr>
                            <td class="align-center">Network (IPv4 CIDR block)</td>
                            <td class="align-center"><input type="text" id="cladnet-cidr-block"/><span>(IP address / Subnet mask will be converted and provided)</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="align-center">Description</td>
                            <td class="align-center"><input type="text" id="cladnet-description"/></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <button type="button" onclick="createCLADNet()">Create</button>
            </div>
        </div>
    </div>
</section>

<!-- Table -->
<section>

</section>


<script type="text/javascript">
    function createCLADNet() {

        // Get the network (IPv4 CIDR block) and description to create CLADNet
        let elemCLADNetCIDRBlock = document.getElementById("cladnet-cidr-block");
        let elemCLADNetDescription = document.getElementById("cladnet-description");

        console.log("CLADNetCIDRBlock:" + elemCLADNetCIDRBlock.value);
        console.log("CLADNetDescription:" + elemCLADNetDescription.value);


        // Build JSON data
        // Example:
        // {
        //     "CLADNetID":"cladnet1",
        //     "CIDRBlock":"xxx.xxx.xxx.xxx/xx",
        //     "gatewayIP": "xxx.xxx.xxx.1",
        //     "description": "xxxxx"
        // }

        let confInfo = JSON.stringify({
            "CLADNetID": "",
            "CIDRBlock": elemCLADNetCIDRBlock.value,
            "gatewayIP": "",
            "description": elemCLADNetDescription.value
        });

        console.log("JSON String of configuration information:");
        console.log(confInfo);

        // Send those to the AdminWeb server
        ws.send(confInfo);

    }
</script>


<script type="text/javascript">

    let loc = window.location;
    let uri = 'ws:';

    if (loc.protocol === 'https:') {
        uri = 'wss:';
    }
    uri += '//' + loc.host;
    uri += '/ws';

    console.log("WS URI: " + uri);
    ws = new WebSocket(uri)

    ws.onopen = function () {
        console.log('Connected')
    }

    ws.onmessage = function (evt) {
        console.log("Data received: ");
        console.log(evt.data);
        let msg = JSON.parse(evt.data);
        console.log("Data parsed: ");
        console.log(msg);

        switch (msg.type) {
            case "CLADNetList":
                console.log("CLADNetList:");
                console.log(msg.text);
                let list = JSON.parse(msg.text);
                console.log("Parsed CLADNetList: ");
                console.log(list);

                let elemNetworkingRuleData = document.getElementById("cladnet-data")

                // This table show a list of Cloud Adaptive Network
                let tbody = '';
                for (let i = 0; i < list.length; i++) {
                    tbody += ('<tr>' +
                        '<td class="align-center">' + list[i].CLADNetID + '</td>' +
                        '<td class="align-center">' + list[i].CIDRBlock + '</td>' +
                        '<td class="align-center">' + list[i].description + '</td>' +
                        '</tr>');
                }
                elemNetworkingRuleData.innerHTML = tbody;

                break;
            case "NetworkingRule":
                console.log("NetworkingRule:");
                console.log(msg.text);
                let rule = JSON.parse(msg.text);
                console.log("Parsed NetworkingRule: ");
                console.log(rule);

                // To be update based on msg.type = "networkingRule"

                // Data sample
                // data = "{\"hostID\":[\"2\"],\"hostIPCIDRBlock\":[\"192.168.10.2/23\"],\"hostIPAddress\":[\"192.168.10.2\"],\"PublicIP\":[\"xxx.xxx.xxx.xxx\"]}";
                // {
                //     "CLADNetID":"cladnet1",
                //     "hostID": ["2", "5"],
                //     "hostIPCIDRBlock": ["xxx.xxx.xxx.2/yy", "xxx.xxx.xxx.3/yy"],
                //     "hostIPAddress": ["xxx.xxx.xxx.2", "xxx.xxx.xxx.3"],
                //     "publicIPAddress": ["aaa.aaa.aaa.aaa", "bbb.bbb.bbb.bbb"]
                // };

                buildNetworkingRuleTable(rule);

                let obj = buildChartData(rule);
                chartDataFrame.series.pop();
                chartDataFrame.series.push(obj);
                // Update chart
                Highcharts.chart('container', chartDataFrame);

                break;

            default:
                console.log("Unknown type of message");
        }

    }

    function buildChartData(json) {
        // Another loop gonna be added to show multi-CLADNet
        let obj = {
            name: json.CLADNetID,
            data: []
        };

        let len = json.hostID.length;
        for (let i = 0; i < len; i++) {
            obj.data.push(
                {
                    name: json.hostID[i],
                    value: Math.floor(Math.random() * 30 + 1),
                    network: json.hostIPCIDRBlock[i] + " - " + json.publicIPAddress[i]
                });
        }

        return obj;
    }

    function buildNetworkingRuleTable(json) {
        let elemNetworkingRuleData = document.getElementById("net-rule-data")

        // This table gonna be updated to show multiple networking rules of CLADNets
        let tbody = '';
        let len = json.hostID.length;
        for (let i = 0; i < len; i++) {
            tbody += ('<tr>' +
                '<td class="align-center">' + json.hostID[i] + '</td>' +
                '<td class="align-center">' + json.hostIPCIDRBlock[i] + '</td>' +
                '<td class="align-center">' + json.hostIPAddress[i] + '</td>' +
                '<td class="align-center">' + json.publicIPAddress[i] + '</td>' +
                '</tr>');
        }
        elemNetworkingRuleData.innerHTML = tbody;
    }
</script>

<script type="text/javascript">
    chartDataFrame = {
        chart: {
            type: 'packedbubble',
            height: '100%'
        },
        title: {
            text: 'The Cloud-Barista Network (CB-Net) configuration'
        },
        tooltip: {
            useHTML: true,
            pointFormat: '<b>{point.name}:</b> {point.network}'
        },
        plotOptions: {
            packedbubble: {
                minSize: '20%',
                maxSize: '100%',
                zMin: 0,
                zMax: 1000,
                layoutAlgorithm: {
                    gravitationalConstant: 0.05,
                    splitSeries: true,
                    seriesInteraction: false,
                    dragBetweenSeries: true,
                    parentNodeLimit: true
                },
                dataLabels: {
                    enabled: true,
                    format: '{point.name}',
                    filter: {
                        property: 'y',
                        operator: '>',
                        value: 0
                    },
                    style: {
                        color: 'black',
                        textOutline: 'none',
                        fontWeight: 'normal'
                    }
                }
            }
        },
        series: []
    };

    function generateDummyData() {
        var temp;
        for (i = 4; i > 1; i--) {
            temp = {
                name: 'CBNet' + i,
                data: []
            }
            MAX = Math.floor(Math.random() * 3 + 3);
            prefix = Math.floor(Math.random() * 24 + 1);
            for (j = 1; j < MAX; j++) {
                pub = Math.floor(Math.random() * 128 + 1) + "." +
                    Math.floor(Math.random() * 128 + 1) + "." +
                    Math.floor(Math.random() * 255 + 1) + "." +
                    Math.floor(Math.random() * 255 + 1);

                temp.data.push({
                    name: 'VM' + j,
                    value: Math.floor(Math.random() * 30 + 1),
                    network: "10.0." + MAX + "." + (j + 1) + "/" + prefix + " - " + pub
                });
            }
            chartDataFrame.series.push(temp);
        }
        Highcharts.chart('container', chartDataFrame);
    }

    // generateDummyData();
</script>

<!-- Scripts -->
<script src="/introspect/assets/js/jquery.min.js"></script>
<script src="/introspect/assets/js/skel.min.js"></script>
<script src="/introspect/assets/js/util.js"></script>
<script src="/introspect/assets/js/main.js"></script>

</body>
</html>
